<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Article</title>
<style>
  body{font-family:Inter, system-ui, sans-serif;background:#f7f9fc;padding:2rem}
  .container{max-width:900px;margin:0 auto;background:#fff;border-radius:12px;padding:28px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
  .post-title{font-size:2rem;margin:0 0 8px}
  .post-date{color:#666;margin-bottom:14px}
  .post-image{width:100%;max-height:420px;object-fit:cover;border-radius:8px;margin-bottom:14px}
  .post-content img{max-width:100%;height:auto;border-radius:6px}
  .back{display:inline-block;margin-bottom:14px;color:#1565c0;text-decoration:none}
</style>
</head>
<body>
  <div class="container" id="post">Loadingâ€¦</div>

<!-- Contentful Rich Text HTML renderer (UMD) -->
<script src="https://unpkg.com/@contentful/rich-text-html-renderer/dist/rich-text-html-renderer.umd.js"></script>

<script>
const spaceId = "4l890vk1ti4c";
const accessToken = "bPbgjAoOo6pmJT3DTI82TSry6MQh8zwuHEbi9VtVkmA";

function findAssetUrl(assetId, includes) {
  if (!includes || !includes.Asset) return "";
  const asset = includes.Asset.find(a => a.sys.id === assetId);
  return asset ? ("https:" + (asset.fields.file?.url || asset.fields.file?.details?.file?.url || "")) : "";
}
function findEntry(entryId, includes) {
  if (!includes || !includes.Entry) return null;
  return includes.Entry.find(e => e.sys.id === entryId) || null;
}

async function fetchPost() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");
  if (!id) {
    document.getElementById("post").innerHTML = "<p>No article id provided.</p>";
    return;
  }

  const url = `https://cdn.contentful.com/spaces/${spaceId}/environments/master/entries/${id}?access_token=${accessToken}&include=2`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data || !data.fields) {
    document.getElementById("post").innerHTML = "<p>Article not found.</p>";
    return;
  }
  const post = data.fields;
  const imageId = post.featuredImage?.sys?.id;
  const hero = imageId ? findAssetUrl(imageId, data.includes) : "";

  // render Rich Text (post.content)
  let bodyHtml = "";
  if (post.content) {
    const r = window.contentfulRichTextHtmlRenderer;
    bodyHtml = r.documentToHtmlString(post.content, {
      renderNode: {
        // handle embedded assets in Rich Text
        'embedded-asset-block': (node) => {
          const id = node.data?.target?.sys?.id;
          const url = findAssetUrl(id, data.includes);
          const alt = node.data?.target?.fields?.title || "";
          return url ? `<p><img src="${url}" alt="${alt}" /></p>` : "";
        },
        // handle embedded entries (basic)
        'embedded-entry-block': (node) => {
          const id = node.data?.target?.sys?.id;
          const entry = findEntry(id, data.includes);
          if (!entry) return "";
          const t = entry.fields.title || "";
          const b = entry.fields.description || "";
          return `<div class="embedded-entry"><h4>${t}</h4><p>${b}</p></div>`;
        }
      }
    });
  }

  const prettyDate = post.publishedDate || data.sys?.createdAt || "";
  const dateStr = prettyDate ? (new Date(prettyDate)).toLocaleDateString() : "";

  document.getElementById("post").innerHTML = `
    <a class="back" href="articles.html">&larr; Back to Articles</a>
    <h1 class="post-title">${post.title || ""}</h1>
    <div class="post-date">${dateStr}</div>
    ${hero ? `<img class="post-image" src="${hero}" alt="${post.title || ''}" />` : ""}
    <div class="post-content">${bodyHtml}</div>
  `;
}

fetchPost().catch(err => {
  console.error(err);
  document.getElementById("post").innerHTML = "<p>Error loading article.</p>";
});
</script>
</body>
</html>
